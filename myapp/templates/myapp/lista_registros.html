{% extends 'myapp/base.html' %}
{% load static %}

{% block title %}Listado de Visitas{% endblock %}

{% block scripts %}
<script src="{% static 'myapp/JAV/js_lista_regsitro.js' %}" defer></script>
{% endblock %}

{% block content %}
<!-- Sección de botones superiores -->
<div class="row">
  <div class="offset-9 col-md-3">
    <div class="d-flex mb-3">
      <!-- Botón para abrir modal de nuevo registro -->
      <button
        type="button"
        id="btnNuevoRegistro"
        class="btn boton bt-body me-2"
        data-url="{% url 'lista_registros' %}"
        data-bs-toggle="modal"
        data-bs-target="#miModal"
      >
        Nuevo Registro
      </button>

      <!-- Botón para eliminar selección múltiple -->
      <button type="button" class="btn boton bt-body" id="botonEliminar">
        Borrar Selección
      </button>
    </div>
  </div>
</div>

<!-- Mostrar mensajes del sistema -->
{% if mensaje %}
<div class="alert alert-info alert-dismissible fade show">
  {{ mensaje }}
  <button
    type="button"
    class="btn-close"
    data-bs-dismiss="alert"
    aria-label="Close"
  ></button>
</div>
{% endif %}

<!-- Cuerpo de la tarjeta con la tabla de registros -->
<div class="card shadow-sm mb-4">
  <!-- Encabezado de la tarjeta -->
  <div class="card-header py-3 text-center" style="background-color: #4A4A4A">
      <h5 class="mb-0 text-white"><i class="fas fa-users me-2"></i>Registros de Visitantes</h5>
  </div>

  <!-- Formulario oculto para eliminación múltiple -->
  <form
      id="formEliminarSeleccionados"
      method="POST"
      action="{% url 'eliminar_seleccionados' %}"
  >
      {% csrf_token %}
      <input type="hidden" name="ids" id="idsSeleccionados" />
  </form>

  <!-- Cuerpo de la tarjeta con la tabla de registros -->
  <div class="card-body p-0">
      <div class="table-responsive">
          <table class="table table-hover table-bordered mb-0">
              <!-- Encabezados de la tabla -->
              <thead class="text-white" style="background-color: #4A4A4A">
                  <tr>
                      <th scope="col" width="50">Sel.</th>
                      <th scope="col" width="80">ID</th>
                      <th scope="col" width="100">Fecha</th>
                      <th scope="col" width="120">Tamaño Grupo</th>
                      <th scope="col" width="100">Extranjero</th>
                      <th scope="col" width="120">País Origen</th>
                      <th scope="col" width="120">Procedencia</th>
                      <th scope="col" width="120">Transporte</th>
                      <th scope="col" width="150">Motivo</th>
                      <th scope="col" width="100">Estancia</th>
                      <th scope="col" width="100">N° Visitas</th>
                      <th scope="col" width="120">Encuestador</th>
                      <th scope="col" width="180">Acciones</th>
                  </tr>
              </thead>

              <!-- Cuerpo de la tabla con datos dinámicos -->
              <tbody>
                  {% for r in registros %}
                  <tr class="align-middle">
                      <!-- Checkbox para selección múltiple -->
                      <td>
                          <div class="form-check d-flex justify-content-center">
                              <input
                                  class="form-check-input checkbox-seleccion"
                                  type="checkbox"
                                  value="{{ r.id_registro }}"
                                  style="width: 18px; height: 18px;"
                              />
                          </div>
                      </td>

                      <!-- Datos del registro -->
                      <td>
                          <span class="badge rounded-pill" style="background-color: #4A4A4A">{{ r.id_registro }}</span>
                      </td>
                      <td>{{ r.fecha }}</td>
                      <td>{{ r.tamanio_grupo }}</td>
                      <td>
                          {% if r.es_extranjero %}
                          <span class="badge rounded-pill" style="background-color: #4A4A4A; color: white;">
                              Sí
                          </span>
                          {% else %}
                          <span class="badge rounded-pill" style="background-color: #D6CEAA; color: #4A4A4A;">
                              No
                          </span>
                          {% endif %}
                      </td>
                      <td>{{ r.pais_origen|default:"-" }}</td>
                      <td>{{ r.procedencia|default:"-" }}</td>
                      <td>{{ r.tipo_transporte }}</td>
                      <td>{{ r.motivo_visita }}</td>
                      <td>{{ r.estancia_dias }}</td>
                      <td>{{ r.numero_visitas }}</td>
                      <td>
                          <span class="badge rounded-pill" style="background-color: #4A4A4A">{{ r.id_encuestador }}</span>
                      </td>

                      <!-- Botones de acciones -->
                      <td>
                          <div class="d-flex gap-2">
                              <!-- Botón para eliminar registro individual -->
                              <button
                                  class="btn btn-sm btn-eliminar"
                                  data-id="{{ r.id_registro }}"
                                  style="background-color: #e74c3c; border: none; color: white;"
                              >
                                  <i class="fas fa-trash me-1"></i> Eliminar
                              </button>

                              <!-- Botón para editar registro -->
                              <button
                                  class="btn btn-sm btn-editar"
                                  data-id="{{ r.id_registro }}"
                                  style="background-color: #D6CEAA; border: none; color: #4A4A4A;"
                              >
                                  <i class="fas fa-edit me-1"></i> Editar
                              </button>
                          </div>
                      </td>
                  </tr>
                  {% endfor %}
              </tbody>
          </table>
      </div>
  </div>
</div>

<!-- Botón para respaldo de datos -->
<div class="offcanvas-body">
  <button
    class="btn boton boton-menu"
    type="button"
    onclick="window.location.href='/backup/'"
  >
    Respaldo de datos
  </button>
</div>

<!-- Modal para formularios (crear/editar registros) -->
<div
  class="modal fade"
  id="miModal"
  tabindex="-1"
  aria-labelledby="tituloModal"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <!-- Formulario dentro del modal -->
      <form
        class="needs-validation g-3"
        novalidate
        name="formulario"
        id="formulario"
        method="POST"
        action="{% url 'lista_registros' %}"
        enctype="multipart/form-data"
      >
        {% csrf_token %}

        <!-- Encabezado del modal -->
        <div class="modal-header custom-modal-header position-relative">
          <h5 class="modal-title w-100 text-center" id="tituloModal">
            Agregar Formulario
          </h5>
          <button
            type="button"
            class="btn-close position-absolute end-0 me-3"
            id="cerrarModal"
            data-bs-dismiss="modal"
            aria-label="Cerrar"
          ></button>
        </div>

        <!-- Cuerpo del modal con el formulario incrustado -->
        <div class="modal-body">
          <div class="row p-3 p-md-6 mb-3">
            {% include 'myapp/mod_db/form.html' %}
          </div>
          <!-- Botón de envío del formulario -->
          <input
            type="submit"
            class="btn boton bt-body"
            value="Guardar"
          />
        </div>

        <!-- Pie del modal con botones -->
        <div class="modal-footer custom-modal-footer">
          <button
            type="button"
            class="btn btn-warning"
            data-bs-dismiss="modal"
          >
            Cerrar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
